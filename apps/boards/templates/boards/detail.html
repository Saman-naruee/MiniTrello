{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load board_extras %}
{% block title %}{{ board.title }} - MiniTrello{% endblock %}
{% block extra_head %}
<<<<<<< HEAD
<script defer="" src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<!-- Custom CSS -->
<link href="{% static 'boards/css/boards.css' %}" rel="stylesheet"/>
=======
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'boards/css/boards.css' %}">
>>>>>>> 53c2dc37e323beaf708f89a27f016bebfd89f00d
<style>
/* --- Custom scroll and layout styles --- */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1090;
}

.list-container {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    min-height: calc(100vh - 250px);
    overflow-x: auto;
    align-items: flex-start;
    scroll-behavior: smooth;
    position: relative;
}

/* Scroll fade indicators */
.list-container::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 50px;
    background: linear-gradient(to left, rgba(255, 255, 255, 0.9), transparent);
    pointer-events: none;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.list-container.scrollable::after {
    opacity: 1;
}
.list-column {
    min-width: 300px;
    max-width: 300px;
    flex-shrink: 0; /* Prevents lists from shrinking */
}
.sortable-ghost {
    opacity: 0.4;
    background-color: #c8ebfb;
>>>>>>> 53c2dc37e323beaf708f89a27f016bebfd89f00d
}
</style>
{% endblock %}
{% block content %}
<<<<<<< HEAD
<!-- In your board detail page -->
<button class="btn btn-danger" data-bs-target="#modal-container" data-bs-toggle="modal" hx-get="{% url 'delete_board' board.id %}" hx-swap="innerHTML" hx-target="#modal-container">{% trans "Delete Board" %}</button>
<div class="container-fluid p-0" x-data="boardApp()">
{% trans "Board Header" %}
<div class="board-header p-3 mb-3">
<div class="container-fluid">
<div class="d-flex justify-content-between align-items-center">
<div>
<h1 class="h3 mb-1">{{ board.title }}</h1>
{% if board.description %}
<p class="text-muted mb-0">{{ board.description }}</p>
{% endif %}
</div>
<div class="d-flex gap-2">
<button class="btn btn-outline-primary btn-sm" data-bs-target="#addListModal" data-bs-toggle="modal" hx-get="{% url 'create_list' board_id=board.id %}" hx-swap="innerHTML" hx-target="#create-list-form-container">
<i class="fas fa-plus me-1"></i>{% trans "Add List" %}</button>
<button class="btn btn-outline-secondary" hx-get="{% url 'board_members' board.id %}" hx-swap="innerHTML" hx-target="#board-members">
<i class="fas fa-users"></i>{% trans "Members" %}</button>
<div id="board-members"></div>
</div>
</div>
</div>
</div>
{% trans "Lists Container" %}
<div class="list-container d-flex gap-3 px-3" id="lists-container">
{% for list in lists %}
<div class="list-column" id="list-{{ list.id }}">
<div class="card list-card">
<div class="card-header d-flex justify-content-between align-items-center">
<h6 class="mb-0">{{ list.title }}</h6>
<div class="dropdown">
<button aria-expanded="false" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-ellipsis-v"></i>
</button>
<ul class="dropdown-menu">
<li>
<button @click="addCardToList({{ list.id }}, {{ board.id }})" class="dropdown-item">
<i class="fas fa-plus me-2"></i>{% trans "Add Card" %}</button>
</li>
<li>
<button class="dropdown-item" hx-confirm="Are you sure you want to delete this list?" hx-delete="{% url 'delete_list' board.id list.id %}" hx-swap="outerHTML" hx-target="#list-{{ list.id }}">
<i class="fas fa-trash me-2"></i>{% trans "Delete List" %}</button>
</li>
</ul>
</div>
</div>
<div class="card-body p-2" id="cards-container-{{ list.id }}">
{% for card in list.prefetched_cards %}
{% include "boards/partials/card_item.html" with card=card board_id=board.id list_id=list.id %}
{% empty %}
<div class="text-center py-3">
<p class="text-muted small mb-0">{% trans "No cards yet" %}</p>
<button @click="addCardToList({{ list.id }}, {{ board.id }})" class="btn btn-outline-primary btn-sm mt-2">
<i class="fas fa-plus me-1"></i>{% trans "Add Card" %}</button>
</div>
{% endfor %}
</div>
<div class="card-footer bg-transparent p-2">
<button @click="addCardToList({{ list.id }}, {{ board.id }})" class="btn btn-outline-primary btn-sm w-100">
<i class="fas fa-plus me-1"></i>{% trans "Add Card" %}</button>
</div>
</div>
</div>
{% empty %}
<div class="col-12 text-center py-5">
<i class="fas fa-list fa-3x text-muted mb-3"></i>
<h4 class="text-muted">{% trans "No lists yet" %}</h4>
<p class="text-muted">{% trans "Create your first list to get started!" %}</p>
<button class="btn btn-primary" data-bs-target="#addListModal" data-bs-toggle="modal" hx-get="{% url 'create_list' board_id=board.id %}" hx-swap="innerHTML" hx-target="#create-list-form-container">
<i class="fas fa-plus me-2"></i>{% trans "Create List" %}</button>
</div>
{% endfor %}
</div>
{% trans "Add List Modal" %}
<div #}="" accessibility="" add="" an="" aria-hidden="true" aria-labelledby="addListModalLabel" bootstrap="" class="modal fade" for="" id="" tabindex="-1" target="" to="" {#="">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="addListModalLabel">{% trans "Add New List" %}</h5>{% trans "{# Add an ID for accessibility #}" %}<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body" id="create-list-form-container">
{% trans "HTMX will load the form here" %}
</div>{% trans "&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD" %}<form @submit="showAddListModal = false" class="modal-body" hx-post="{% url 'boards:create_list' %}" hx-swap="beforeend" hx-target="#lists-container">
{% csrf_token %}
<input name="board" type="hidden" value="{{ board.id }}"/>
<div class="mb-3">
<label class="form-label" for="list-title">{% trans "List Title" %}</label>
<input class="form-control" id="list-title" maxlength="255" name="title" placeholder="Enter list title" required="" type="text"/>
</div>
<div class="modal-footer">
<button @click="showAddListModal = false" class="btn btn-secondary" type="button">{% trans "Cancel" %}</button>
<button class="btn btn-primary" type="submit">{% trans "Create List" %}</button>
</div>
</form>{% trans "{% trans "=======
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 489139fdbe472089d0b91d717bf1bc1f1a51740b" %}" %}</div>
</div>
</div>
{% trans "Add Card Modal" %}
<div #}="" accessibility="" add="" an="" aria-hidden="true" aria-labelledby="addCardModalLabel" bootstrap="" class="modal fade" for="" id="" tabindex="-1" target="" to="" {#="">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="addCardModalLabel">{% trans "Add New Card" %}</h5>{% trans "{# Add an ID for accessibility #}" %}<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body" id="create-card-form-container">
{% trans "HTMX will load the form here" %}
</div>{% trans "&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD" %}<form @submit="showAddCardModal = false" class="modal-body" hx-post="{% url 'boards:create_card' %}" hx-swap="beforeend" x-bind:hx-target="`#cards-container-${selectedListId}`">
{% csrf_token %}
<input name="list" type="hidden" x-bind:value="selectedListId"/>
<div class="mb-3">
<label class="form-label" for="card-title">{% trans "Card Title" %}</label>
<input class="form-control" id="card-title" maxlength="255" name="title" placeholder="Enter card title" required="" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="card-description">{% trans "Description (Optional)" %}</label>
<textarea class="form-control" id="card-description" name="description" placeholder="Enter card description" rows="3"></textarea>
</div>
<div class="mb-3">
<label class="form-label" for="card-priority">{% trans "Priority" %}</label>
<select class="form-select" id="card-priority" name="priority">
<option value="60">Low</option>
<option selected="" value="50">Medium</option>
<option value="40">High</option>
<option value="30">Important</option>
<option value="20">Important and Urgent</option>
<option value="10">Top</option>
</select>
</div>
<div class="modal-footer">
<button @click="showAddCardModal = false" class="btn btn-secondary" type="button">{% trans "Cancel" %}</button>
<button class="btn btn-primary" type="submit">{% trans "Create Card" %}</button>
</div>
</form>{% trans "{% trans "=======
&gt;&gt;&gt;&gt;&gt;&gt;&gt; 489139fdbe472089d0b91d717bf1bc1f1a51740b" %}" %}</div>
</div>
</div>
{% trans "Edit Card Modal" %}
<div class="modal fade" style="display: none;" tabindex="-1" x-show="showEditCardModal" x-transition="">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">{% trans "Edit Card" %}</h5>
<button @click="showEditCardModal = false" class="btn-close" type="button"></button>
</div>{% trans "&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD" %}<form =="&lt;form" hx-patch="{% url 'boards:update_card' 0 %}" x-bind:hx-patch="`/boards/cards/${editingCardId}/update/`">&gt;&gt;&gt;&gt;&gt;&gt; 489139fdbe472089d0b91d717bf1bc1f1a51740b
x-bind:hx-target="`#card-${editingCardId}`"
hx-swap="outerHTML"
@submit="showEditCardModal = false"
class="modal-body"&gt;
{% csrf_token %}
<input name="card_id" type="hidden" x-bind:value="editingCardId"/>
<div class="mb-3">
<label class="form-label" for="edit-card-title">{% trans "Card Title" %}</label>
<input class="form-control" id="edit-card-title" maxlength="255" name="title" placeholder="Enter card title" required="" type="text" x-bind:value="editingCardTitle"/>
</div>
<div class="mb-3">
<label class="form-label" for="edit-card-description">{% trans "Description (Optional)" %}</label>
<textarea class="form-control" id="edit-card-description" name="description" placeholder="Enter card description" rows="3" x-bind:value="editingCardDescription"></textarea>
</div>
<div class="mb-3">
<label class="form-label" for="edit-card-priority">{% trans "Priority" %}</label>
<select class="form-select" id="edit-card-priority" name="priority" x-bind:value="editingCardPriority">
<option value="60">Low</option>
<option value="50">Medium</option>
<option value="40">High</option>
<option value="30">Important</option>
<option value="20">Important and Urgent</option>
<option value="10">Top</option>
</select>
</div>
<div class="modal-footer">
<button @click="showEditCardModal = false" class="btn btn-secondary" type="button">{% trans "Cancel" %}</button>
<button class="btn btn-primary" type="submit">{% trans "Save Changes" %}</button>
</div>
</form>
</div>
</div>
</div>
{% trans "Members Modal Trigger (Button)" %}
<div class="d-flex justify-content-end">
<button class="btn btn-secondary" hx-get="{% url 'board_members' board.id %}" hx-swap="innerHTML" hx-target="#members-modal-content">{% trans "Members" %}</button>
</div>
{% trans "Members Modal (Bootstrap)" %}
<div aria-hidden="true" aria-labelledby="membersModalLabel" class="modal fade" id="membersModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="membersModalLabel">{% trans "Board Members" %}</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body" id="members-modal-content">
{% trans "HTMX will load the members list here" %}
</div>
</div>
</div>
</div>
</div>
<script>
function boardApp() {
return {
showAddListModal: false,
showAddCardModal: false, // This will be managed by Bootstrap now
showEditCardModal: false,
showMembersModal: false,
selectedListId: null,
editingCardId: null,
editingCardTitle: '',
editingCardDescription: '',
editingCardPriority: 50,
// Show add card modal for specific list
addCardToList(listId, boardId) {
this.selectedListId = listId;
// Open the Bootstrap modal first
const addCardModal = new bootstrap.Modal(document.getElementById('addCardModal'));
addCardModal.show();
// Then, trigger an HTMX GET to load the form into the modal
htmx.ajax('GET', `/boards/${boardId}/lists/${listId}/cards/create/`, {
target: `#create-card-form-container`,
swap: 'innerHTML',
});
},
// Show edit card modal
editCard(cardId, title, description, priority) {
this.editingCardId = cardId;
this.editingCardTitle = title;
this.editingCardDescription = description;
this.editingCardPriority = priority;
this.showEditCardModal = true;
}
}
}
// HTMX event listener to close the Add List Modal on successful list creation
document.body.addEventListener('htmx:afterSwap', function(evt) {
if (evt.detail.target.id === 'lists-container' && evt.detail.xhr.status === 200 && evt.detail.requestHeaders['HX-Trigger'] === 'listCreated') {
const addListModal = new bootstrap.Modal(document.getElementById('addListModal'));
addListModal.hide();
}
});
// HTMX event listener to close the Add Card Modal on successful card creation
document.body.addEventListener('htmx:afterSwap', function(evt) {
// Check if the swap was for a new card and was successful
// We're targeting #cards-container-${selectedListId} for successful card additions
// and expecting an HX-Trigger 'cardCreated' from the server.
if (evt.detail.target.closest('[id^="cards-container-"]') && evt.detail.xhr.status === 200 && evt.detail.requestHeaders['HX-Trigger'] === 'cardCreated') {
const addCardModal = new bootstrap.Modal(document.getElementById('addCardModal'));
addCardModal.hide();
}
=======
<div class="container-fluid p-0" x-data="boardApp()">
    
    {# --- Toast container for displaying messages --- #}
    <div class="toast-container" 
         x-data="{ show: false, message: '' }"
         @show-message.window="show = true; message = $event.detail.message; setTimeout(() => show = false, 4000)">
        <div x-show="show" x-transition class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" @click="show = false"></button>
            </div>
            <div class="toast-body" x-text="message">
                Notification message.
            </div>
        </div>
    </div>
    
    {# --- Your original, more detailed Board Header --- #}
    <div class="board-header p-3 mb-3" style="background: linear-gradient(135deg, {{ board.color }}20, {{ board.color }}40); border-bottom: 3px solid {{ board.color }};">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'boards:boards_list' %}" class="btn btn-sm btn-outline-secondary mb-2">← Back to Boards</a>
                <div id="board-title-section-{{ board.id }}">
                    {% include 'boards/partials/board_title_section.html' %}
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-light" hx-get="{% url 'boards:create_list' board_id=board.id %}" hx-target="#generic-modal-content" data-bs-toggle="modal" data-bs-target="#genericModal">+ Add List</button>
                <a href="{% url 'invitations:send_invitation' board_id=board.id %}" class="btn btn-sm btn-success">+ Add Member</a>
                <button class="btn btn-sm btn-warning" hx-get="{% url 'boards:update_board' board.id %}" hx-target="#generic-modal-content" data-bs-toggle="modal" data-bs-target="#genericModal">Update</button>
                <button class="btn btn-sm btn-danger" hx-get="{% url 'boards:delete_board' board.id %}" hx-target="#generic-modal-content" data-bs-toggle="modal" data-bs-target="#genericModal">Delete</button>
                {# ❗❗❗ CORE FIX: Add the "View Members" button here ❗❗❗ #}
                <button class="btn btn-sm btn-info"
                        hx-get="{% url 'boards:board_members' board_id=board.id %}"
                        hx-target="#generic-modal-content"
                        data-bs-toggle="modal"
                        data-bs-target="#genericModal">
                    View Members
                </button>
            </div>
        </div>
    </div>

    {# --- Generic modals used by different HTMX actions --- #}
    <div class="modal fade" id="genericModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" id="generic-modal-content">
                {# Content (forms for update/delete list/board) is loaded here by HTMX #}
            </div>
        </div>
    </div>
    <div class="modal fade" id="addCardModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" id="create-card-form-container">
                {# Content (form for creating cards) is loaded here by HTMX #}
            </div>
        </div>
    </div>

    {# --- Scroll control buttons --- #}
    <div class="scroll-controls position-fixed top-50 end-0 translate-middle-y d-flex flex-column gap-2 z-index-100">
        <button id="scroll-right" class="btn btn-light shadow" @click="scrollContainer('right')">
            <i class="fas fa-chevron-right"></i>
        </button>
        <button id="scroll-left" class="btn btn-light shadow" @click="scrollContainer('left')">
            <i class="fas fa-chevron-left"></i>
        </button>
    </div>

    {# --- The main container for all lists, now with correct classes --- #}
    <div class="list-container" id="lists-container" data-board-id="{{ board.id }}">
        {% for list in lists %}
            {% include "boards/partials/list_column.html" with list=list board=board %}
        {% empty %}
            <div class="w-100 text-center py-5">
                <h4 class="text-muted">No lists yet.</h4>
                <button class="btn btn-primary mt-3"
                        hx-get="{% url 'boards:create_list' board_id=board.id %}"
                        hx-target="#generic-modal-content"
                        data-bs-toggle="modal"
                        data-bs-target="#genericModal">
                    Create your first list
                </button>
            </div>
        {% endfor %}
    </div>
</div>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
// AlpineJS function for client-side interactions
function boardApp() {
    return {
        container: null,

        init() {
            this.container = document.getElementById('lists-container');
            this.updateScrollIndicators();
            this.container.addEventListener('scroll', () => this.updateScrollIndicators());
            window.addEventListener('resize', () => this.updateScrollIndicators());
        },

        updateScrollIndicators() {
            if (!this.container) return;

            const canScrollLeft = this.container.scrollLeft > 0;
            const canScrollRight = this.container.scrollLeft < (this.container.scrollWidth - this.container.clientWidth);

            this.container.classList.toggle('scrollable-left', canScrollLeft);
            this.container.classList.toggle('scrollable', canScrollRight);
        },

        scrollContainer(direction, amount = 320) {
            if (!this.container) return;

            const currentScroll = this.container.scrollLeft;
            const targetScroll = direction === 'left'
                ? currentScroll - amount
                : currentScroll + amount;

            this.container.scrollTo({
                left: targetScroll,
                behavior: 'smooth'
            });
        },

        addCardToList(listId, boardId) {
            const addCardModal = new bootstrap.Modal(document.getElementById('addCardModal'));
            htmx.ajax('GET', `/boards/${boardId}/lists/${listId}/cards/create/`, {
                target: '#create-card-form-container',
                swap: 'innerHTML'
            }).then(() => {
                addCardModal.show();
            });
        }
    }
}

// Drag & Drop script for moving cards
document.addEventListener('DOMContentLoaded', () => {
    document.body.addEventListener('htmx:configRequest', function(evt) {
        // ❗❗❗ CORE FIX: This is the standard way to add the CSRF token for all HTMX requests.
        // It reads the token from the cookie Django sets.
        evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    });

    let containers = document.querySelectorAll('.cards-sortable-container');
    containers.forEach(container => {
        new Sortable(container, {
            group: 'cards',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const cardId = evt.item.dataset.cardId;
                const toListId = evt.to.dataset.listId;
                const fromListId = evt.from.dataset.listId;
                const boardId = evt.from.closest('.list-container').dataset.boardId;
                const newIndex = evt.newIndex;
                const url = `/boards/${boardId}/lists/${fromListId}/cards/${cardId}/move/`;

                const payload = {
                    to_list_id: toListId,
                    new_index: newIndex
                };
                
                // ❗❗❗ SIMPLIFIED CALL: No manual headers needed anymore!
                // We use hx-vals to let HTMX handle encoding.
                htmx.ajax('PUT', url, {
                    swap: 'none', // We don't need to swap any content on success
                    values: payload // Use 'values' instead of 'body' for automatic encoding
                }).catch(err => {
                    console.error("HTMX request failed:", err);
                    // Optionally, show an error message to the user here
                });
            }
        });
    });
});





// General event listener for closing modals and showing messages after successful HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.xhr.status >= 400) return; // Ignore failed requests

    const hxTrigger = evt.detail.xhr.getResponseHeader('HX-Trigger');
    if (!hxTrigger) return;
    
    try {
        const triggerData = JSON.parse(hxTrigger);

        // Check for any of our custom events that should close a modal
        if (triggerData.boardUpdated || triggerData.listCreated || triggerData.cardCreated || triggerData.listUpdated) {
            
            const genericModalEl = document.getElementById('genericModal');
            if (genericModalEl) {
                const modal = bootstrap.Modal.getInstance(genericModalEl);
                if (modal) modal.hide();
            }

            const addCardModalEl = document.getElementById('addCardModal');
            if (addCardModalEl) {
                const modal = bootstrap.Modal.getInstance(addCardModalEl);
                if (modal) modal.hide();
            }
        }

        // Check for a message to show in a toast
        if (triggerData.showMessage) {
            window.dispatchEvent(new CustomEvent('show-message', {
                detail: { message: triggerData.showMessage }
            }));
        }
    } catch (e) {
        // This can happen if the trigger is a simple string, which is fine.
    }
>>>>>>> 53c2dc37e323beaf708f89a27f016bebfd89f00d
});
</script>
{% endblock %}
