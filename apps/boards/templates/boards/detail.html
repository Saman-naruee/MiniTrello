{% extends 'base.html' %}
{% load static %}
{% load board_extras %}
{% block title %}{{ board.title }} - MiniTrello{% endblock %}

{% block extra_head %}
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<link rel="stylesheet" href="{% static 'boards/css/boards.css' %}">
<style>
    /* Styles for displaying notification messages */
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1090;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0" x-data="boardApp()">

    <!-- Display notification messages -->
    <div class="toast-container" 
         x-data="{ show: false, message: '' }"
         @show-message.window="show = true; message = $event.detail.message; setTimeout(() => show = false, 3000)">
        <div x-show="show" x-transition class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" @click="show = false"></button>
            </div>
            <div class="toast-body" x-text="message">
                Notification message.
            </div>
        </div>
    </div>

    <!-- Buttons for adding members, updating board, and deleting board -->
    <div class="mb-3 d-flex gap-2">
        <a href="{% url 'boards:add_member' board_id=board.id %}" class="btn btn-success">
            + Add Member
        </a>
        <button class="btn btn-warning"
                hx-get="{% url 'boards:update_board' board.id %}"
                hx-target="#generic-modal-body"
                data-bs-toggle="modal"
                data-bs-target="#genericModal">
            Update Board
        </button>
        <button class="btn btn-danger"
                hx-get="{% url 'boards:delete_board' board.id %}"
                hx-target="#generic-modal-body"
                data-bs-toggle="modal"
                data-bs-target="#genericModal">
            Delete Board
        </button>
    </div>

    <!-- Generic modal -->
    <div class="modal fade" id="genericModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" id="generic-modal-body">
                <!-- Content will be rendered by HTMX -->
            </div>
        </div>
    </div>

    <!-- Board header -->
    <div class="board-header p-3 mb-3">
        <div class="container-fluid">
            <div id="board-title-section-{{ board.id }}">
                {% include 'boards/partials/board_title_section.html' %}
            </div>
        </div>
    </div>

    <!-- Lists container -->
    <div class="list-container d-flex gap-3 px-3" id="lists-container">
        {% for list in board.lists.all %}
            {% include "boards/partials/list_column.html" %}
        {% endfor %}
    </div>
</div>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
function boardApp() { return { /* ... */ } }

// ========= Listen for HTMX events and show notification messages =========
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.xhr.status < 400) { // Only for successful requests

        const triggerData = JSON.parse(evt.detail.xhr.getResponseHeader('HX-Trigger'));

        // If boardUpdated trigger is sent, hide the modal
        if (triggerData && triggerData.boardUpdated) {
            const modalElement = document.getElementById('genericModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }

        // If a message for display is sent, send a custom event for AlpineJS
        if (triggerData && triggerData.showMessage) {
            window.dispatchEvent(new CustomEvent('show-message', {
                detail: { message: triggerData.showMessage }
            }));
        }
    }
});
</script>
{% endblock %}

