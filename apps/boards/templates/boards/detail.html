{% extends 'base.html' %}
{% load static %}
{% load board_extras %}
{% block title %}{{ board.title }} - MiniTrello{% endblock %}

{% block extra_head %}
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<link rel="stylesheet" href="{% static 'boards/css/boards.css' %}">
<style>
/* ... your styles (no changes) ... */
.board-header { background: linear-gradient(135deg, {{ board.color }}20, {{ board.color }}40); border-bottom: 3px solid {{ board.color }}; }
.toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1090; }
.list-container { min-height: calc(100vh - 200px); overflow-x: auto; display: flex; gap: 1rem; padding: 1rem; }
.list-column { min-width: 300px; max-width: 300px; }
.sortable-ghost { opacity: 0.4; background-color: #c8ebfb; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0" x-data="boardApp()">
    
    {# --- Toast container for displaying messages --- #}
    <div class="toast-container" 
         x-data="{ show: false, message: '' }"
         @show-message.window="show = true; message = $event.detail.message; setTimeout(() => show = false, 4000)">
        <div x-show="show" x-transition class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" @click="show = false"></button>
            </div>
            <div class="toast-body" x-text="message"></div>
        </div>
    </div>

    {# --- Main top-level action buttons for the board --- #}
    <div class="p-3 d-flex flex-wrap gap-2 align-items-center border-bottom">
        <a href="{% url 'boards:boards_list' %}" class="btn btn-sm btn-outline-secondary">← Back to Boards</a>
        <span class="text-muted mx-2">Board:</span>
        <div id="board-title-section-{{ board.id }}">
             {% include 'boards/partials/board_title_section.html' %}
        </div>
        <div class="ms-auto d-flex gap-2">
            <a href="{% url 'boards:add_member' board_id=board.id %}" class="btn btn-sm btn-success">+ Add Member</a>
            <button class="btn btn-sm btn-warning"
                    hx-get="{% url 'boards:update_board' board.id %}"
                    hx-target="#generic-modal-body" data-bs-toggle="modal" data-bs-target="#genericModal">
                Update Board
            </button>
            <button class="btn btn-sm btn-danger"
                    hx-get="{% url 'boards:delete_board' board.id %}"
                    hx-target="#generic-modal-body" data-bs-toggle="modal" data-bs-target="#genericModal">
                Delete Board
            </button>
        </div>
    </div>

    {# --- Generic modals used by different HTMX actions --- #}
    <div class="modal fade" id="genericModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content" id="generic-modal-body"></div></div></div>
    <div class="modal fade" id="addCardModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content" id="create-card-form-container"></div></div></div>

    {# --- Colored board header with the Add List button --- #}
    <div class="board-header p-3">
        <div class="d-flex justify-content-end align-items-center">
            <button class="btn btn-outline-light btn-sm"
                    hx-get="{% url 'boards:create_list' board_id=board.id %}"
                    hx-target="#generic-modal-body" data-bs-toggle="modal" data-bs-target="#genericModal">
                + Add List
            </button>
        </div>
    </div>

    {# --- Main container for all the lists --- #}
    <div class="list-container" id="lists-container" data-board-id="{{ board.id }}">
        {% for list in lists %}
            {% include "boards/partials/list_column.html" with list=list board=board %}
        {% empty %}
            <div class="col-12 text-center py-5"><h4 class="text-muted">No lists yet.</h4></div>
        {% endfor %}
    </div>
</div>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
// AlpineJS function for client-side interactions
function boardApp() { 
    return {
        addCardToList(listId, boardId) {
            const addCardModal = new bootstrap.Modal(document.getElementById('addCardModal'));
            htmx.ajax('GET', `/boards/${boardId}/lists/${listId}/cards/create/`, {
                target: '#create-card-form-container',
                swap: 'innerHTML'
            }).then(() => {
                addCardModal.show();
            });
        }
    } 
}

// ================== CORRECTED Drag & Drop Script ==================
document.addEventListener('DOMContentLoaded', (event) => {
    let cardContainers = document.querySelectorAll('.cards-sortable-container');
    
    cardContainers.forEach(container => {
        new Sortable(container, {
            group: 'cards',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const cardId = evt.item.dataset.cardId;
                const toListId = evt.to.dataset.listId;
                const boardId = evt.from.closest('.list-container').dataset.boardId;
                const fromListId = evt.from.dataset.listId; 
                const newIndex = evt.newIndex;
                
                // Construct the correct dynamic URL
                const url = `/boards/${boardId}/lists/${fromListId}/cards/${cardId}/move/`;
                
                // Prepare the data payload
                const payload = {
                    to_list_id: toListId,
                    new_index: newIndex
                };
                
                // ❗❗❗ CORE FIX: Send data as a JSON string and set the correct header
                htmx.ajax('PUT', url, {
                    body: JSON.stringify(payload),
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json' // Explicitly set content type
                    }
                });
            }
        });
    });
});

// Event listener for closing modals and showing messages after successful HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.xhr.status >= 400) return; // Ignore failed requests

    const hxTrigger = evt.detail.xhr.getResponseHeader('HX-Trigger');
    if (!hxTrigger) return;
    
    try {
        const triggerData = JSON.parse(hxTrigger);

        if (triggerData.boardUpdated || triggerData.listCreated || triggerData.cardCreated) {
            // Find and close any active modals
            const genericModalEl = document.getElementById('genericModal');
            if (genericModalEl) {
                const modal = bootstrap.Modal.getInstance(genericModalEl);
                if (modal) modal.hide();
            }
            const addCardModalEl = document.getElementById('addCardModal');
            if (addCardModalEl) {
                const modal = bootstrap.Modal.getInstance(addCardModalEl);
                if (modal) modal.hide();
            }
        }

        if (triggerData.showMessage) {
            // Dispatch a custom event for AlpineJS to catch and display a toast message
            window.dispatchEvent(new CustomEvent('show-message', {
                detail: { message: triggerData.showMessage }
            }));
        }
    } catch (e) {
        // This can happen if the trigger is a simple string, which is fine.
    }
});
</script>
{% endblock %}
