{% extends 'base.html' %}
{% load socialaccount %}

{% block title %}MiniTrello - Register{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6 offset-md-3">
        <div class="card">
            <div class="card-header">
                <h2>Register</h2>
            </div>
            <div class="card-body">
                <div x-data="{
                    username: '',
                    email: '',
                    password1: '',
                    password2: '',
                    errors: {},
                    loading: false,
                    
                    validateAndSubmit() {
                        this.errors = {};
                        
                        // Frontend validation: require at least username or email
                        if (!this.username.trim() && !this.email.trim()) {
                            this.errors.__all__ = ['You must provide either a username or an email address.'];
                            return;
                        }
                        
                        // If username provided, validate it
                        if (this.username.trim() && this.username.trim().length < 3) {
                            this.errors.username = ['Username must be at least 3 characters long.'];
                            return;
                        }
                        
                        // If email provided, do basic email validation
                        if (this.email.trim() && !this.email.trim().includes('@')) {
                            this.errors.email = ['Please enter a valid email address.'];
                            return;
                        }
                        
                        // Submit form if validation passes
                        this.submitForm();
                    },
                    
                    submitForm() {
                        this.loading = true;
                        this.errors = {};
                        
                        const formData = new FormData();
                        formData.append('username', this.username);
                        formData.append('email', this.email);
                        formData.append('password1', this.password1);
                        formData.append('password2', this.password2);
                        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                        
                        fetch('{% url 'account_signup' %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                                return;
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.form && data.form.errors) {
                                this.errors = data.form.errors;
                            }
                            this.loading = false;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            this.errors = {'__all__': ['An unexpected error occurred. Please try again.']};
                            this.loading = false;
                        });
                    }
                }" x-init="
                    username = `{{ form.username.value|default:''|safe }}`;
                    email = `{{ form.email.value|default:''|safe }}`;
                    password1 = `{{ form.password1.value|default:''|safe }}`;
                    password2 = `{{ form.password2.value|default:''|safe }}`;
                ">
                    <!-- Registration Form with Alpine.js and Django form integration -->
                    <form method="post" @submit.prevent="validateAndSubmit">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors|join:", " }}
                            </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">{{ form.username.label }}:</label>
                            <input type="text" 
                                   name="username" 
                                   x-model="username" 
                                   id="{{ form.username.id_for_label }}" 
                                   class="form-control {% if form.username.errors %}is-invalid{% endif %}" 
                                   value="{{ form.username.value|default:'' }}" 
                                   :class="{ 'is-invalid': errors.username }"
                                   maxlength="{{ form.username.field.max_length }}">
                            <div class="invalid-feedback d-block">
                                {% if form.username.errors %}{{ form.username.errors|join:", " }}{% endif %}
                                <span x-show="errors.username" x-text="errors.username[0]"></span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}:</label>
                            <input type="email" 
                                   name="email" 
                                   x-model="email" 
                                   id="{{ form.email.id_for_label }}" 
                                   class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                   value="{{ form.email.value|default:'' }}" 
                                   :class="{ 'is-invalid': errors.email }">
                            <div class="invalid-feedback d-block">
                                {% if form.email.errors %}{{ form.email.errors|join:", " }}{% endif %}
                                <span x-show="errors.email" x-text="errors.email[0]"></span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.password1.id_for_label }}" class="form-label">{{ form.password1.label }}:</label>
                            <input type="password" 
                                   name="password1" 
                                   x-model="password1" 
                                   id="{{ form.password1.id_for_label }}" 
                                   class="form-control {% if form.password1.errors %}is-invalid{% endif %}" 
                                   value="{{ form.password1.value|default:'' }}" 
                                   required 
                                   :class="{ 'is-invalid': errors.password1 }">
                            <div class="invalid-feedback d-block">
                                {% if form.password1.errors %}{{ form.password1.errors|join:", " }}{% endif %}
                                <span x-show="errors.password1" x-text="errors.password1[0]"></span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.password2.id_for_label }}" class="form-label">{{ form.password2.label }}:</label>
                            <input type="password" 
                                   name="password2" 
                                   x-model="password2" 
                                   id="{{ form.password2.id_for_label }}" 
                                   class="form-control {% if form.password2.errors %}is-invalid{% endif %}" 
                                   value="{{ form.password2.value|default:'' }}" 
                                   required 
                                   :class="{ 'is-invalid': errors.password2 }">
                            <div class="invalid-feedback d-block">
                                {% if form.password2.errors %}{{ form.password2.errors|join:", " }}{% endif %}
                                <span x-show="errors.password2" x-text="errors.password2[0]"></span>
                            </div>
                        </div>
                        
                        <div x-show="errors.__all__ && !form.non_field_errors" class="alert alert-danger" x-text="errors.__all__[0]"></div>
                        
                        <button type="submit" class="btn btn-primary" :disabled="loading">
                            <span x-show="loading" class="spinner-border spinner-border-sm me-1"></span>
                            Register
                        </button>
                    </form>
                </div>
                
                <hr>
                
                <div class="social-register">
                    <p>Or register with:</p>
                    <a href="{% provider_login_url 'google' %}" class="btn btn-danger w-100">
                        <i class="fab fa-google me-2"></i> Google
                    </a>
                </div>
                
                <div class="mt-3 text-center">
                    <p>Already have an account? <a href="{% url 'account_login' %}" hx-boost="true">Login here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
