{% extends "base.html" %}
{% load socialaccount %}
{% load i18n %}
{% block title %}Account Connections{% endblock %}

{% block content %}
<div class="container py-4">
<div class="row justify-content-center">
<div class="col-md-8">
<div class="card shadow-sm">
<div class="card-header bg-primary text-white">
<h2 class="h4 mb-0">
<i class="fas fa-link me-2"></i>{% trans "Account Connections" %}</h2>
</div>
<div class="card-body">
<p class="text-muted mb-4">{% trans "Connect your account with these services to enable easier login and access to additional features." %}</p>
          
          {% if form.accounts %}
          <h3 class="h5 mb-3">{% trans "Connected Accounts" %}</h3>
<div class="list-group mb-4" id="connected-accounts">
            {% for base_account in form.accounts %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
<div>
<h4 class="h6 mb-1">{{ base_account.provider|title }}</h4>
<p class="text-muted small mb-0">{% trans "Connected on {{ base_account.date_added|date:"M d, Y" }}" %}</p>
</div>
<form action="{% url 'socialaccount_connections' %}" hx-post="{% url 'socialaccount_connections' %}" hx-swap="outerHTML" hx-target="#connected-accounts" method="post">
                {% csrf_token %}
                <input name="account" type="hidden" value="{{ base_account.id }}"/>
<button class="btn btn-sm btn-outline-danger" hx-confirm="Are you sure you want to disconnect this account?" name="action_remove" type="submit">
<i class="fas fa-unlink me-1"></i>{% trans "Disconnect" %}</button>
</form>
</div>
            {% endfor %}
          </div>
          {% endif %}
          
          <h3 class="h5 mb-3">{% trans "Available Connections" %}</h3>
<div class="row row-cols-1 row-cols-md-2 g-4">
            {% for provider in socialaccount_providers %}
            <div class="col">
<div class="card h-100">
<div class="card-body">
<h4 class="card-title">{{ provider.name|title }}</h4>
<p class="card-text small text-muted">{% trans "Connect your account with {{ provider.name }} for easier login." %}</p>
<a class="btn btn-outline-primary" href="{% provider_login_url provider.id process='connect' %}">
<i class="fab fa-{{ provider.id|lower }} me-1"></i>{% trans "Connect" %}</a>
</div>
</div>
</div>
            {% endfor %}
          </div>
</div>
<div class="card-footer">
<a class="btn btn-outline-secondary" href="{% url 'account_email' %}">
<i class="fas fa-envelope me-1"></i>{% trans "Manage Emails" %}</a>
<a class="btn btn-outline-secondary" href="{% url 'account_change_password' %}">
<i class="fas fa-key me-1"></i>{% trans "Change Password" %}</a>
<a class="btn btn-link" href="{% url 'Home' %}">{% trans "Back to Home" %}</a>
</div>
</div>
</div>
</div>
</div>
<!-- Toast for notifications -->
<div @click="show = false" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11; display: none;" x-data="{ show: false, message: '', type: 'success' }" x-init="
       window.addEventListener('connectionAction', (e) =&gt; {
         message = e.detail.message;
         type = e.detail.type || 'success';
         show = true;
         setTimeout(() =&gt; { show = false }, 5000);
       });
     " x-show="show" x-transition="">
<div :class="'toast show bg-' + type + ' text-white'" aria-atomic="true" aria-live="assertive" role="alert">
<div class="toast-header">
<strong class="me-auto">Notification</strong>
<button @click="show = false" class="btn-close" type="button"></button>
</div>
<div class="toast-body" x-text="message"></div>
</div>
</div>
<script>
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.xhr.status === 200) {
      // Dispatch custom event for toast
      window.dispatchEvent(new CustomEvent('connectionAction', {
        detail: { 
          message: 'Account connection has been removed!', 
          type: 'success' 
        }
      }));
    }
  });
</script>
{% endblock %}
