<div class="modal-header">
    <h5 class="modal-title" id="cardDetailModalLabel">{{ card.title }}</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<div class="modal-body">
    <div class="card-info mb-4">
        <h6>Description</h6>
        <p>{{ card.description }}</p>
        
        <div class="row">
            <div class="col-md-6">
                <p><strong>Priority:</strong> {{ card.get_priority_display }}</p>
                <p><strong>Due Date:</strong> {{ card.due_date|default:"No due date" }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Assignee:</strong> {{ card.assignee.username|default:"Unassigned" }}</p>
            </div>
        </div>
    </div>

    <div class="mini-tasks mb-4">
        <h6>Mini Tasks</h6>
        <ul class="list-group">
            {% for task in mini_tasks %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input" 
                           {% if task.is_completed %}checked{% endif %}
                           hx-post="{% url 'boards:toggle_mini_task' %}"
                           hx-vals='{"task_id": "{{ task.id }}"}'
                           hx-trigger="change">
                    <label class="form-check-label {% if task.is_completed %}text-muted{% endif %}">
                        {{ task.text }}
                    </label>
                </div>
            </li>
            {% endfor %}
        </ul>
        <form hx-post="{% url 'boards:add_mini_task' board_id=card.list.board.id list_id=card.list.id card_id=card.id %}"
              hx-target="closest ul"
              hx-swap="beforeend"
              class="mt-2">
            {{ mini_task_form.as_p }}
            <button type="submit" class="btn btn-sm btn-primary">Add Task</button>
        </form>
    </div>

    <div class="comments">
        <h6>Comments</h6>
        {% for comment in comments %}
        <div class="comment mb-2">
            <strong>{{ comment.user.username }}</strong>
            <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
            <p>{{ comment.text }}</p>
        </div>
        {% endfor %}
        
        <form hx-post="{% url 'boards:add_comment' board_id=card.list.board.id list_id=card.list.id card_id=card.id %}"
              hx-target="closest .comments"
              hx-swap="beforeend"
              class="mt-3">
            {{ comment_form.as_p }}
            <button type="submit" class="btn btn-sm btn-primary">Add Comment</button>
        </form>
    </div>
</div>

<!-- Add this to your base template if not already present -->
<script>
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.closest('#cardDetailModal')) {
        $('#cardDetailModal').modal('show');
    }
});
</script>
